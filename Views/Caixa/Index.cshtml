@model IEnumerable<ControleEstoqueLoja.Models.Produto>

<style>
    #sugestoes {
        display: none;
        position: absolute;
        width: 100%;
        z-index: 9999; /* Garante que aparece na frente de tudo */
        background: white;
        border: 1px solid #ccc;
        max-height: 200px;
        overflow-y: auto;
    }

    .list-group-item {
        cursor: pointer;
    }

        .list-group-item:hover {
            background-color: #f8f9fa;
        }


</style>

<div class="main-container">
    <h1 class="text-center fw-bold">CAIXA - LOJA</h1>

    <div class="row">
        <div class="col-md-5">
            <div class="tabela-card">
                <div class="card-header bg-primary text-white text-center py-2 rounded-top">
                    <h5 class="mb-0">ENTRADA DE ITENS</h5>
                </div>

                <div class="p-3">
                    <div class="mb-3">
                        <label class="form-label fw-bold">PRODUTO (Nome ou ID)</label>
                        <div class="position-relative">
                            <input type="text" id="campoBusca" class="form-control" placeholder="Bipe o código..."
                                   onkeypress="if(event.key === 'Enter') buscarProdutoPorCodigo(this.value)" autocomplete="off" />
                            <div id="sugestoes" class="list-group"></div>
                        </div>
                    </div>

                    <div class="modal fade" id="modalVendaConfirmacao" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header bg-primary text-white">
                                    <h5 class="modal-title">Confirmar Item</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" id="produtoIdVenda" />
                                    <h4 id="modalNomeProduto" class="fw-bold">---</h4>
                                    <div class="alert alert-info">
                                        Estoque Disponível: <strong id="modalEstoqueDisponivel">0</strong>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Quantidade:</label>
                                        <!-- ALTERADO: id distinto para o campo do modal -->
                                        <input type="number" id="modalCampoQtd" class="form-control" value="1">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-primary" onclick="confirmarItem()">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="painelItem" class="p-3 border rounded bg-light mb-3 text-center">
                        <h6 class="text-muted small">Item Selecionado</h6>
                        <h3 id="displayNome" class="fw-bold text-dark">---</h3>
                        <h2 class="text-success fw-bold" id="exibirPreco">R$ 0,00</h2>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="fw-bold">QUANTIDADE</label>
                            <input type="number"
                                   id="campoQtd"
                                   class="form-control form-control-lg"
                                   value="0"
                                   step="0.001"
                                   min="0.1"
                                   onfocus="this.select()" />
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button type="button" id="btnConfirmar" onclick="confirmarItem()" class="btn btn-success">
                                CONFIRMAR
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="tabela-card">
                <div class="card-header bg-primary text-white py-2 rounded-top">
                    <h5 class="mb-0">🧾 LISTA DE COMPRAS</h5>
                </div>

                <div class="p-0">
                    <div style="height: 300px; overflow-y: auto; background: white;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Item</th>
                                    <th>Qtd</th>
                                    <th>Preço</th>
                                    <th>Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="carrinho"></tbody>
                        </table>
                    </div>

                    <div class="bg-white text-dark p-3 d-flex justify-content-between align-items-center">
                        <h3 class="mb-0">TOTAL:</h3>
                        <h1 id="displayTotal" class="mb-0 text-warning fw-bold">R$ 0,00</h1>
                    </div>

                    <div class="p-3 bg-light border-top">
                        <button type="button" class="btn btn-success btn-lg w-100 fw-bold py-3 shadow" onclick="abrirModalPagamento()">
                            <i class="bi bi-cart-check"></i> FINALIZAR VENDA
                        </button>
                    </div>

                    <form id="formCaixa" style="display:none;">
                        <input type="hidden" id="inputMetodoPagamento" />
                        <input type="hidden" id="inputCPFCliente" />
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


@* Dados ocultos *@
<div id="dadosProdutos" style="display:none;">
    @if (ViewBag.Produtos != null)
    {
        foreach (var itemProd in (IEnumerable<ControleEstoqueLoja.Models.Produto>)ViewBag.Produtos)
        {
            <div data-id="@itemProd.Id"
                 data-nome="@itemProd.Nome"
                 data-codigo="@itemProd.CodigoBarras"
                 data-preco="@itemProd.Preco.ToString("F2").Replace(",", ".")"
                 data-tipo="@((int)itemProd.Tipo)">
            </div>
        }
    }
</div>


@* --- MODAIS UNIFICADOS --- *@
<div id="modalPagamento" class="modal-overlay">
    <div class="modal-box" style="width: 450px; border-top: 5px solid #004d1a;">

        <div id="secaoPagamento">
            <h3 class="fw-bold mb-4" style="color: #004d1a;">PAGAMENTO</h3>
            <div class="d-grid gap-2 mb-4">
                <button type="button" class="btn-metodo-sel" onclick="marcarMetodo(this, 'Cartão Crédito')">💳 Cartão Crédito</button>
                <button type="button" class="btn-metodo-sel" onclick="marcarMetodo(this, 'Cartão Débito')">💳 Cartão Débito</button>
                <button type="button" class="btn-metodo-sel" onclick="marcarMetodo(this, 'PIX')">📱 PIX</button>
                <button type="button" class="btn-metodo-sel" onclick="marcarMetodo(this, 'Voucher')">🎟️ Voucher</button> 
                <button type="button" class="btn-metodo-sel" onclick="marcarMetodo(this, 'Dinheiro')">💵 Dinheiro</button>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-success flex-grow-1 py-3 fw-bold" onclick="irParaCPF()">CONFIRMAR</button>
                <button type="button" class="btn btn-outline-secondary flex-grow-1" onclick="fecharModal()">CANCELAR</button>
            </div>
        </div>

        <div class="row mt-3">
        </div>

        <div id="secaoTroco" class="p-3 border rounded bg-white shadow-sm mb-4" style="display: none;">
            <div class="row align-items-center">
                <div class="col-6">
                    <label class="form-label fw-bold mb-1">Valor Recebido</label>
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        <input type="number" id="valorRecebidoInput" class="form-control form-control-lg"
                               placeholder="0,00" step="0.01" oninput="calcularTroco()">
                    </div>
                </div>
                <div class="col-6 text-end">
                    <label class="form-label fw-bold mb-1 d-block">Troco</label>
                    <h2 id="displayTroco" class="text-success fw-bold m-0">R$ 0,00</h2>
                    <input type="hidden" id="valorTrocoInput" value="0">
                </div>
            </div>
        </div>

        <div id="secaoCPF" style="display: none;">
            <h4 class="fw-bold mb-3" style="color: #004d1a;">CPF NA NOTA?</h4>
            <p class="text-muted small">Opcional. Deixe em branco se não desejar.</p>
            <input type="text" id="cpfClienteInput" class="form-control form-control-lg text-center mb-4" placeholder="000.000.000-00" maxlength="14">

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-success flex-grow-1 py-3 fw-bold" onclick="enviarVendaDeVez()">FINALIZAR E IMPRIMIR</button>
                <button type="button" class="btn btn-outline-secondary" onclick="voltarParaPagamento()">VOLTAR</button>
            </div>
        </div>

    </div>
</div>

<script>
        
    // --- 1. VARIÁVEIS GLOBAIS ---
    let carrinho = [];
    let itemAtual = null;
    let metodoSelecionado = "";
    let codigoVendedorInformado = "";

    // --- 2. INICIALIZAÇÃO E EVENTOS DE ENTRADA ---
    document.addEventListener("DOMContentLoaded", function() {
        const campoBusca = document.getElementById("campoBusca");
        const campoQtd = document.getElementById("campoQtd");
        const btnConfirmar = document.getElementById("btnConfirmar");

        // Focar no campo de busca ao abrir
        campoBusca.focus();

        // Máscara de CPF automática
        const cpfInput = document.getElementById('cpfClienteInput');
        if (cpfInput) {
            cpfInput.addEventListener('input', function (e) {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length > 11) v = v.slice(0, 11);
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d)/, '$1.$2');
                v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                e.target.value = v;
            });
        }

            let inputBuffer = "";
    document.addEventListener('keydown', function (e) {
        // Se você estiver digitando no CPF ou Cupom, ignora o bip
        if (e.target.tagName === "INPUT") return;

        if (e.key === "Enter") {
            if (inputBuffer.length > 0) {
                buscarProdutoPorCodigo(inputBuffer);
                inputBuffer = ""; // Limpa para o próximo bip
            }
        } else {
            // Apenas números interessam para o código de barras
            if (!isNaN(e.key)) {
                inputBuffer += e.key;
            }
        }
    });

        // 1) Handler do botão confirmar (DOM Loaded)
        document.getElementById("btnConfirmar").onclick = () => {
            const campoQtd = document.getElementById("campoQtd");
            const quantidade = parseFloat((campoQtd.value || "0").toString().replace(',', '.')) || 0;

            if (!itemAtual) {
                alert("Selecione um produto primeiro!");
                return;
            }

            if (quantidade <= 0) {
                alert("Informe uma quantidade válida!");
                return;
            }

            const qtdString = quantidade.toString().replace(',', '.');
            const precoString = (itemAtual.preco ?? 0).toString().replace(',', '.');

            const novoItem = {
                id: itemAtual.id,
                ProdutoId: itemAtual.id,
                nome: itemAtual.nome,
                preco: itemAtual.preco,
                qtd: quantidade,
                Quantidade: qtdString,
                Preco: precoString,
                labelQtd: qtdString,
                subtotal: (itemAtual.preco || 0) * quantidade,
                estoque: (itemAtual.estoque !== undefined && itemAtual.estoque !== null) ? parseFloat(itemAtual.estoque) : 0
            };

            carrinho.push(novoItem);
            renderCarrinho();

            document.getElementById("campoBusca").value = "";
            document.getElementById("campoQtd").value = "";
            document.getElementById("displayNome").innerText = "AGUARDANDO PRODUTO...";
            document.getElementById("exibirPreco").innerText = "R$ 0,00";
            itemAtual = null;
            document.getElementById("campoBusca").focus();
        }; // <-- fim do handler dentro do DOMContentLoaded

}); // <-- ADICIONAR ESTA LINHA: fecha o document.addEventListener("DOMContentLoaded", ...)

// 2) adicionarItemAoCarrinho - garante shape consistente
function adicionarItemAoCarrinho() {
    const qtdInput = document.getElementById("campoQtd");
    const quantidade = parseFloat((qtdInput.value || "0").toString().replace(',', '.'));

    if (!itemAtual || isNaN(quantidade) || quantidade <= 0) {
        Swal.fire('Ops', 'Selecione o produto e a quantidade corretamente.', 'warning');
        return;
    }

    const qtdString = quantidade.toString().replace(',', '.');
    const precoString = (itemAtual.preco ?? 0).toString().replace(',', '.');

    const novoItem = {
        ProdutoId: itemAtual.id,
        id: itemAtual.id,
        nome: itemAtual.nome,
        preco: itemAtual.preco,
        qtd: quantidade,
        Quantidade: qtdString,
        Preco: precoString,
        subtotal: (itemAtual.preco || 0) * quantidade,
        estoque: (itemAtual.estoque !== undefined && itemAtual.estoque !== null) ? parseFloat(itemAtual.estoque) : 0
    };

    carrinho.push(novoItem);
    // Chamada corrigida: usar a função existente `renderCarrinho`
    renderCarrinho();

    itemAtual = null;
    document.getElementById("campoBusca").value = "";
    document.getElementById("campoQtd").value = "";
    document.getElementById("displayNome").innerText = "AGUARDANDO PRODUTO...";
    document.getElementById("exibirPreco").innerText = "R$ 0,00";
    document.getElementById("campoBusca").focus();
}

// 3) confirmarItem - adiciona propriedade estoque e normaliza strings
function confirmarItem() {
    const campoQtd = document.getElementById("campoQtd");
    const qtdDigitada = (campoQtd.value || "0").toString().replace(',', '.');
    const qtdNumerica = parseFloat(qtdDigitada) || 0;

    if (!itemAtual) {
        Swal.fire('Erro', 'Selecione um produto primeiro!', 'error');
        return;
    }

    if (qtdNumerica <= 0) {
        Swal.fire('Erro', 'Informe a quantidade!', 'error');
        campoQtd.focus();
        return;
    }

    const precoString = (itemAtual.preco ?? 0).toString().replace(',', '.');

    const novoItem = {
        ProdutoId: itemAtual.id.toString(),
        nome: itemAtual.nome,
        preco: itemAtual.preco,
        qtd: qtdNumerica,
        Quantidade: qtdDigitada,
        Preco: precoString,
        subtotal: (itemAtual.preco || 0) * qtdNumerica,
        estoque: (itemAtual.estoque !== undefined && itemAtual.estoque !== null) ? parseFloat(itemAtual.estoque) : 0
    };

    carrinho.push(novoItem);
    renderCarrinho();

    itemAtual = null;
    document.getElementById("campoBusca").value = "";
    campoQtd.value = "";
    document.getElementById("displayNome").innerText = "AGUARDANDO PRODUTO...";
    document.getElementById("exibirPreco").innerText = "R$ 0,00";
    document.getElementById("campoBusca").focus();
}

// 4) abrirModalPagamento - validação de estoque mais robusta (normaliza vírgula/ponto)
function abrirModalPagamento() {
    if (carrinho.length === 0) {
        Swal.fire('Aviso', 'O carrinho está vazio!', 'info');
        return;
    }

    let errosEstoque = [];
    carrinho.forEach(item => {
        const qtdPedida = parseFloat(String(item.qtd ?? item.Quantidade ?? item.quantidade ?? 0).replace(',', '.')) || 0;
        const estoqueReal = parseFloat(String(item.estoque ?? 0).replace(',', '.')) || 0;

        if (qtdPedida > estoqueReal) {
            let unidade = (String(item.tipo || '').toUpperCase() === "PESO" || String(item.tipo || '').toUpperCase() === "GRANEL") ? "kg" : "un";
            errosEstoque.push(`Produto: <b>${item.nome}</b><br>Solicitado: ${qtdPedida}${unidade} | Disponível: ${estoqueReal}${unidade}`);
        }
    });

    if (errosEstoque.length > 0) {
        Swal.fire({
            title: 'Indisponibilidade de Estoque',
            html: `
                <div style="text-align: center; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <p>Prezado operador, identificamos que alguns itens no carrinho excedem o saldo disponível em estoque:</p>
                    <div style="margin: 20px 0; padding: 15px; background-color: #fff5f5; border: 1px solid #feb2b2; border-radius: 8px; color: #c53030;">
                        ${errosEstoque.join('<br><hr style="border: 0.5px solid #feb2b2; margin: 10px 0;">')}
                    </div>
                    <p>Por gentileza, realize o ajuste das quantidades antes de prosseguir com o pagamento.</p>
                </div>
            `,
            icon: 'warning',
            confirmButtonColor: '#d33',
            confirmButtonText: 'Retornar ao Caixa',
            allowOutsideClick: false
        });
        return;
    }

    document.getElementById("modalPagamento").style.display = "flex";
    voltarParaPagamento();
}

// 5) enviarVendaDeVez - normaliza shape e formatação antes de enviar
async function enviarVendaDeVez() {
    if (carrinho.length === 0) {
        Swal.fire('Carrinho Vazio', 'Adicione produtos antes de finalizar.', 'warning');
        return;
    }

    const metodo = metodoSelecionado;
    const cpf = document.getElementById("cpfClienteInput")?.value || "";
    const vendedor = typeof codigoVendedorInformado !== 'undefined' ? codigoVendedorInformado : "";
    const valorRec = document.getElementById("valorRecebidoInput")?.value || "0";
    const valorTro = document.getElementById("valorTrocoInput")?.value || "0";

    const data = new URLSearchParams();
    data.append("metodoPagamento", metodo);
    data.append("cpfCliente", cpf);
    data.append("codigoVendedor", vendedor);
    data.append("valorRecebido", String(valorRec).replace(',', '.'));
    data.append("valorTroco", String(valorTro).replace(',', '.'));

    carrinho.forEach((item, i) => {
        const prefixo = `itens[${i}]`;

        const produtoId = item.ProdutoId ?? item.id ?? "";
        data.append(`${prefixo}.ProdutoId`, produtoId.toString());

        let qtdRaw = item.Quantidade ?? item.qtd ?? item.quantidade ?? "0";
        qtdRaw = (typeof qtdRaw === "number") ? qtdRaw.toString() : String(qtdRaw);
        qtdRaw = qtdRaw.replace(',', '.');

        let precoRaw = item.Preco ?? item.preco ?? "0";
        precoRaw = (typeof precoRaw === "number") ? precoRaw.toString() : String(precoRaw);
        precoRaw = precoRaw.replace(',', '.');

        data.append(`${prefixo}.Quantidade`, qtdRaw);
        data.append(`${prefixo}.Preco`, precoRaw);
    });

    try {
        Swal.showLoading();

        const response = await fetch('/Caixa/FinalizarVenda', {
            method: 'POST',
            body: data,
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        });

        const res = await response.json();

        if (res.success) {
            $('.modal').modal('hide');
            Swal.fire({
                title: 'Venda Finalizada!',
                text: 'Sucesso ao processar a venda.',
                icon: 'success',
                confirmButtonText: 'OK'
            }).then(() => {
                if (res.vendaId) window.open('/Caixa/GerarCupom?id=' + res.vendaId, '_blank');
                location.reload();
            });
        } else {
            Swal.fire({
                title: 'Erro no Estoque',
                html: res.message.replace(/\n/g, '<br>'),
                icon: 'error',
                confirmButtonColor: '#d33'
            });
        }
    } catch (e) {
        console.error("Erro crítico no envio:", e);
        Swal.fire('Erro de Comunicação', 'O servidor não respondeu. Verifique sua conexão.', 'error');
    }
}
</script>

@if (Context.Request.Query.ContainsKey("imprimirId"))
{
    <script>
        window.addEventListener('load', function() {
            // Usamos o Helper do C# para gerar a URL correta, evitando erro de rota
            var url = '@Url.Action("GerarCupom", "Caixa")' + '?id=' + '@Context.Request.Query["imprimirId"]';

            var win = window.open(url, '_blank');

            if (!win) {
                alert("O navegador bloqueou a abertura do cupom. Por favor, permita pop-ups para este site.");
            }

            // Limpa a URL para não abrir de novo no F5
            window.history.replaceState({}, document.title, window.location.pathname);
        });
    </script>

}